# MEXC出来高トップ10トレードボット - 改良完成版

このボットは、取引所MEXCの出来高トップ10のUSDTペアを自動的に取引するシステムです。さまざまなレビュー指摘事項を踏まえ、拡張性、安定性、セキュリティに優れた実装となっています。

## 主な機能と特徴

### コア機能
- **出来高Top10銘柄への投資**: 24時間出来高が最も多いUSDTペアを自動検出して投資
- **自動保有期間**: 8/10/12時間からランダム選択し、期間後に自動売却
- **リスク管理**: 口座残高の一定割合のみを使用し、各銘柄に均等配分
- **上限管理**: 投資金額に上限を設定し、資産増加時の過剰投資を防止

### セキュリティ機能
- **APIキー暗号化**: PBKDF2とFernetによる強力な暗号化保護
- **マスターパスワード**: ボット起動時に必要なパスワード認証
- **安全なシャットダウン**: 例外発生時の安全な終了処理

### 価格監視と決済機能
- **ストップロス機能**: 設定閾値以下に価格が下落した場合の自動売却
- **動的ストップロス**: 保有時間や利益に応じて調整される高度なストップロス
- **利益確定機能**: 設定閾値以上に価格が上昇した場合の自動売却
- **WebSocket対応**: リアルタイム価格更新（オプション機能）

### エラー耐性と安定性
- **指数バックオフリトライ**: API障害時の効率的な再試行機能
- **ロータリーログ**: 自動ローテーションによるログファイル管理
- **キャッシュ機能**: APIコール削減のための効率的なキャッシング
- **動的チェック間隔**: 決済時間に基づく賢いチェック間隔調整

### 通知と監視
- **複数プラットフォーム通知**: Discord、LINE、Telegram、メールによる通知
- **取引イベント通知**: ポジション開始・終了・ストップロス発動などの通知
- **パフォーマンスレポート**: 定期的な取引成績レポート

### データ管理
- **拡張データベース**: 浮動小数点精度の向上とインデックス最適化
- **統計と分析**: パフォーマンス指標の記録と分析機能
- **API統計**: API呼び出しの成功率やレスポンスタイムの記録

## ファイル構成

- **final_bot.py**: メインボットロジック
- **final_db.py**: 最適化されたデータベース操作
- **config.py**: 設定パラメータとユーティリティ
- **crypto_util.py**: APIキー暗号化ユーティリティ
- **notification.py**: 通知機能モジュール
- **.env.example**: 環境変数設定例

## セットアップ方法

1. 必要なパッケージをインストール
```bash
pip install -r requirements.txt
```

2. 環境変数ファイルを設定
```bash
cp .env.example .env
# .envファイルを編集して設定を行う
```

3. APIキーの暗号化（推奨）
```bash
python crypto_util.py
```

4. ボットの実行
```bash
python final_bot.py
```

## 主な改善点

### 1. ログローテーション
- **RotatingFileHandler実装**: ログファイルのサイズベース自動ローテーション
- **バックアップ制限**: 設定可能なバックアップファイル数

### 2. 指数バックオフリトライ
- **スマートな待機時間**: 2^n秒（1, 2, 4, 8...）の指数関数的なバックオフ
- **詳細エラーログ**: スタックトレースを含む詳細なエラー情報

### 3. 動的チェック間隔
- **効率的なリソース使用**: 決済時間に基づく最適なチェック間隔
- **短縮間隔**: 決済が近いポジションは短い間隔（1分）で頻繁にチェック

### 4. WebSocket対応
- **リアルタイム価格監視**: 定期的なAPI呼び出しに替わる効率的な方法
- **接続監視**: 接続切断時の自動再接続機能

### 5. データベース最適化
- **精度向上**: Numeric(18, 8)型による浮動小数点精度改善
- **複合インデックス**: クエリパフォーマンス向上のための最適化
- **自動マイグレーション**: スキーマ変更のシームレスな対応

### 6. 通知システム
- **マルチプラットフォーム**: Discord、LINE、Telegram、メール対応
- **イベントベース**: 取引開始、終了、ストップロス発動時の通知
- **定期レポート**: 日次パフォーマンス通知

## 高度な機能

### 1. 動的ストップロス
利益が出ている場合、保有時間に応じてストップロス価格を徐々に引き上げることで、利益を保護します。

### 2. 市場安全性チェック
市場全体（BTC/USDT）の状態をモニタリングし、大幅な下落時には新規ポジションの開始を見送ります。

### 3. キャッシュシステム
同じデータに対する重複APIリクエストを防ぎ、レート制限への対応とレイテンシ削減を実現します。

### 4. パフォーマンス分析
取引成績を定期的に記録し、長期的なパフォーマンス評価を可能にします。

## セキュリティのベストプラクティス

1. **DRY_RUNモード**で十分にテストしてから実取引を開始してください
2. **投資上限額**を適切に設定し、過剰投資を防止してください
3. **APIキーの権限**は必要最小限に制限してください（現物取引のみなど）
4. **暗号化機能**を使用し、APIキーを平文で保存しないでください
5. **バックアップ**を定期的に作成し、`trades.sqlite`ファイルを保護してください

## 注意事項

- 仮想通貨取引には高いリスクがあります
- このボットは教育・実験目的で提供されており、投資アドバイスではありません
- 使用は自己責任で行ってください
- 少額からテストを始め、徐々に資金を増やすことをお勧めします